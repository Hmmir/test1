# Gap Report: Что Не Хватает Для Продукта 1-в-1 (10x vs оригинал)

Дата: 2026-02-14  
Проект: `C:\Users\alien\Desktop\10x`

## 0) Важное уточнение про "1 в 1"

Есть два разных смысла “1 в 1”, и от этого зависит список “чего не хватает”:

1. **1:1 по данным и схемам, как у оригинального приватного backend** (`https://mp.btlz-api.ru/api`).  
   Это достигается самым простым способом: проксировать ответы оригинала.
2. **1:1 полностью автономно (без зависимости от чужого backend)**, используя только WB API + вашу БД/настройки.  
   Это самый трудный вариант: нужно воспроизвести экономическую модель, рекламную аналитику, чек-лист с 151 полем, поиск позиций, “поставки” и т.д.

Далее отчет именно в терминах **(2)**, потому что только там реально “не хватает данных/логики” и вы не сможете сделать точную копию без доработок.

## 1) Что сейчас уже сделано (и где 1:1 достигается только прокси)

В `backend_compat/datasets.py` включен **proxy-first** режим: для датасетов из `UPSTREAM_PROXY_DATASETS` сначала идет запрос в оригинальный backend, а локальная сборка используется как fallback.

Файлы:
- `backend_compat/upstream_proxy.py`
- `backend_compat/datasets.py`

Это дает “1:1” **пока** включен `BTLZ_UPSTREAM_ENABLED=1` и оригинал доступен.

## 2) Доказуемые расхождения в автономном режиме (BTLZ_UPSTREAM_ENABLED=0)

Ниже реальные замеры, сделанные локально через `backend_compat/parity_diff.py` и точечные сравнения.

### 2.1 `wb10xMain_planMonth_v1` (план)

Доказательство: `backend_compat/data/parity_report_localonly_plan_fin_20260213.json`

Примеры сильного дрейфа (orig vs local):
- `checklist_buyouts_sum` (MAE ~ 61917)
- `adv_sum_auto_search` (MAE ~ 3941)
- `delivery_mp_with_buyout_rub` (exact_ratio 0.0)

Вывод: локальная модель не воспроизводит то, что делает оригинал (особенно связку с чек-листом и рекламой).

### 2.2 `wb10xSalesFinReportTotal_v1` (фин-отчет)

Доказательство: `backend_compat/data/parity_report_localonly_plan_fin_20260213.json`

Крупные расхождения:
- `direct_costs_no_tax`, `marg_val_no_tax`, `total_to_pay`, `total_wb_comission` (MAE тысячи-десятки тысяч)
- `adv_sum` (MAE ~ 3676)
- `warehouse_price` (MAE ~ 2926)

Вывод: не хватает точной декомпозиции расходов/налогов/комиссий/рекламы и бизнес-правил оригинала.

### 2.3 `wb10xSalesReport_v1/v2` (✅ ОтчетПрод)

Факт: заголовки листа `✅ ОтчетПрод` в шаблоне (`sheet_export.xlsx`) требуют поля:
`barcode`, `tech_size`, `warehouse_name`, `sales_count`, `sales_sum`, `quantity` и др.

Доказательство по текущей локальной сборке:
- локальный `wb10xSalesReport_v1/v2` возвращает ключи только:
  `avg_price`, `brand_name`, `buyout_percent`, `buyouts_count`, `buyouts_sum_rub`, `cancel_*`, `orders_*`, `stocks_*`, `subject_name`, `vendor_code`  
  и **не содержит** полей из `✅ ОтчетПрод`.

Код, который сегодня формирует эти строки: `backend_compat/datasets.py` (ветка `if dataset_name in {"wb10xSalesReport_v1", "wb10xSalesReport_v2"}:`).

Вывод: автономно вы не получите “✅ ОтчетПрод” 1:1 без новой сборки датасета (на уровне строк `barcode/warehouse/size` + агрегации).

### 2.4 `wbJamClusters_v1` (jam_clusters)

Доказательство (точечный запрос):
- оригинал возвращает **82 строки** и схему с полями типа `text_cluster`, `total_views`, `weighted_average_position`, `profit_with_adv`, ...  
- локальная сборка возвращает **0 строк**.

Вывод: локально отсутствует полноценная реализация рекламных кластеров (normquery/adv-часть).

### 2.5 `wbCardsData_v1` (карточки)

Доказательство (orig vs local, один и тот же `nm_id`):
- `basket`: оригинал дает URL вида `https://basket-10.wbbasket.ru/...`, локально сейчас хранится только `"10"`.
- `discounted_price`: в оригинале есть цена, локально часто `0.0`.

Вывод: локальный маппинг карточек WB Content API не совпадает с контрактом оригинала.

### 2.6 `wb10xAnalyticsData_v1` (daily воронка)

Доказательство (сравнение по ключу `(nm_id,date)`):
- оригинал вернул `8` строк за период, локальный builder вернул `24` (локальный код “заполняет” отсутствующие дни нулями).
- есть и расхождения по значениям (пример: `open_card_count` отличается).

Код, который это делает: `backend_compat/datasets.py` функция `_build_analytics_daily_rows()` (блок `if filter_nm_ids: ... for dt in days: ... rows_map[key]=default`).

Вывод: даже если WB API данные близкие, **семантика набора строк** не совпадает (оригинал sparse, локальный dense).

### 2.7 Checklist endpoint `/ss/{id}/dataset/wb/checklist` (151 поле)

Доказательство по схеме:
- в шаблоне `checklist` **151 колонка** (см. `sheet_export.xlsx`, лист `checklist`)
- локальный fallback сейчас отдает **26 ключей** и **не покрывает 130 обязательных ключей**

Пример первых отсутствующих ключей: `acquiring_rub`, `adv_sum_auto`, `ctr_search`, `avg_position`, `card_rating`, `frequency`, `imt_id`, ... (список большой).

Код fallback: `backend_compat/datasets.py` функция `handle_checklist()` (часть после `if upstream_rows is not None`).

Вывод: автономно чек-лист не реализован даже на уровне схемы.

## 3) Что не хватает по backend API (эндпоинты/поведение)

### 3.1 `/ss/datasets/update` не совместим с одним из реальных вызовов скрипта

В `libs/common10x/menu.js` есть вызов:
- `POST /ss/datasets/update` с payload `{ ssId }` (без `dataset`)

Текущий backend (`backend_compat/server.py`) всегда вызывает `parse_dataset_payload()` и вернет `400` на такой запрос.

Нужно:
- поддержать “update all datasets” без `dataset` (минимум: принимать и отвечать `200`).

### 3.2 `/actions` сейчас заглушки, но скрипт ожидает реальное действие

Скрипт использует 4 action-а (по коду `gs_dump`/`libs`):
- `search/positions` (скрипт ждет массив позиций и сам пишет в лист)
- `wb/adv/v1/upd/insert` (скрипт НЕ пишет в лист, значит backend должен сам обновлять лист или возвращать данные в формате, который скрипт применит)
- `sheets/wb-plus/format-rules/reset` (скрипт НЕ сбрасывает правила сам)
- `processGroupCalculations` (поставка: скрипт ожидает, что “расчет” выполнится, сейчас backend не считает)

Текущее состояние: `backend_compat/server.py` метод `_handle_action()` возвращает “accepted”/пустые данные.

Вывод: без реализации actions “поставки”, “отчет РК”, “сброс форматирования” и “позиции” функционально не 1:1.

## 4) Чего не хватает по интеграциям/данным (не только код)

### 4.1 Нужен источник данных для поисковых позиций

WB официально не дает стабильный API “позиция товара по запросу” в рекламном/органическом поиске.

Чтобы сделать 1:1, придется:
- либо парсить публичный поисковый API WB (нестабильно, антибот, регионы),
- либо покупать/подключать сторонний источник позиций,
- либо внедрять собственный crawler.

Без этого вы не заполните часть чек-листа и `search_positions`/лог.

### 4.2 Для `wb/adv/v1/upd/insert` и `format-rules/reset` backend должен уметь менять Google Sheet

Сейчас backend не имеет Google OAuth/Service Account интеграции.

Варианты:
- реализовать Google Sheets API доступ в backend (service account + шаринг таблиц на него),
- или перенести эти действия в Apps Script (тогда backend не нужен для этих действий).

### 4.3 Экономика 1:1 требует “скрытых правил”

Даже при наличии WB отчетов (`reportDetailByPeriod`) оригинал явно применяет:
- дополнительные калибровки,
- правила распределения расходов,
- округления,
- объединения по SKU/размерам/баркодам,
- учет рекламных расходов по SKU,
- учет внешних расходов.

Часть настроек у вас хранится в `plan_month_save`, но этого недостаточно для 1:1 (см. дрейф в parity отчете).

## 5) Несоответствия шаблона таблицы и кода скриптов (листы)

Автоматический поиск “строковых” `getSheetByName('...')` и `sheetName: '...'` показал, что в коде встречаются листы, которых нет в `sheet_export.xlsx`:
- `WB+`
- `ОтчётРК`
- `keys`
- `protection`
- `Чек-лист (прототип)`

Это значит:
- либо шаблон не полный,
- либо код ожидает другие имена/версию таблицы,
- либо эти части меню/функций не будут работать “как в оригинале”.

## 6) Контроль качества (чего не хватает для гарантии “1:1”)

Сейчас нет автоматического набора тестов/фикстур, который гарантирует 1:1 для автономного режима.

Чтобы реально доказуемо “дожать 1:1” без прокси, нужна система:
- фикстуры запросов к WB API (с сохранением ответов),
- golden-файлы (ожидаемые строки датасетов),
- регрессионные тесты по каждому датасету и каждому action-у.

## 7) Минимальный честный вывод

1. **С прокси на `mp.btlz-api.ru`** вы можете иметь 1:1 “по ответам” уже сейчас, но это зависимость от чужого сервиса.
2. **Без прокси** сейчас не хватает:
   - полной реализации `checklist` (151 поле),
   - корректного `wb10xSalesReport_v1/v2` (по баркодам/размерам/складам),
   - рекламных кластеров (`wbJamClusters_v1`),
   - точной экономической модели (plan + finreport),
   - полноценного `/actions` (позиции, реклама, поставки, форматирование),
   - интеграции backend -> Google Sheets API (или перенос действий в Apps Script),
   - автотестов/фикстур для доказуемого 1:1.

