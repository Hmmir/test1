# План: дожать паритет данных и запустить Telegram-канал + бот с подпиской

Дата: 2026-02-18
Проект: `C:\Users\alien\Desktop\10x`

## 0) Прямой результат и зачем этот план

Ниже план, который одновременно решает две задачи:
1) закрыть риск по текущей идентичности данных (уровень ~78-88% в разных прогонах),
2) запустить работающий коммерческий контур через Telegram (канал + бот + оплата подписки + контроль доступа),
без деградации текущего продукта.

Ключевая идея: идти двумя параллельными треками — **Revenue-стабильность сейчас** и **автономный parity uplift**.

---

## 1) Что подтверждено фактами по репозиторию

## 1.1 По паритету

- В текущих отчетах фиксируется неполный parity в автономном режиме:
  - `numeric_exact_ratio = 0.778283` (77.83%) по `checklist_cross`.
  - Исторически в отчетах есть диапазон ~`0.768797..0.783509`.
- Главные зоны дрейфа: `stocks_*`, `adv_sum`, `avg_price_with_spp`, `profit_*`.
- В `GAP_REPORT_1TO1.md` прямо указано, что без исторического слоя и части приватной бизнес-логики конкурента строгий 1:1 недостижим.

## 1.2 По текущей архитектуре

- Бэкенд: `backend_compat/server.py` + `backend_compat/datasets.py` + SQLite (`backend_compat/storage.py`).
- Есть proxy-first механизм на оригинальный backend (`BTLZ_UPSTREAM_ENABLED`, `backend_compat/upstream_proxy.py`).
- Есть локальный snapshot-контур (daily tables + collector), который уже снижает drift.

## 1.3 По Telegram и подпискам

- В репозитории нет реализованного Telegram-бота/канала/биллинга (поиск по `telegram|bot|subscription|invoice` не выявил продуктового контура).
- Значит Telegram monetization нужно строить как новый сервисный слой.

---

## 2) Подтверждение решений по документации (Context7)

Проверено перед планированием:

1. **aiogram** (`/aiogram/aiogram`)
   - production webhook mode поддержан,
   - есть обработчик `pre_checkout_query`,
   - требуется ответ на pre-checkout в ограниченное время.

2. **Telegram Bot API** (`/websites/core_telegram_bots_api`)
   - `answerPreCheckoutQuery` должен быть отправлен в течение 10 секунд,
   - для Telegram Stars используется `currency = XTR`,
   - для Stars `provider_token` не передается,
   - поддержан `subscription_period = 2592000` (30 дней),
   - есть `refundStarPayment`.

3. **FastAPI** (`/fastapi/fastapi`)
   - подходит для webhook/API слоя,
   - есть lifespan/startup/shutdown паттерны,
   - удобно для health-check и фоновых задач.

---

## 3) Целевая стратегия: два трека

## Трек A — Revenue-safe (сразу)

Цель: чтобы клиенты платили и получали сервис стабильно уже сейчас.

- Для платящих клиентов включить режим максимальной точности данных:
  - proxy-first (`BTLZ_UPSTREAM_ENABLED=1`) там, где критичен паритет,
  - локальный fallback как защита от недоступности апстрима.
- Параллельно копить собственные ежедневные снапшоты для постепенного ухода от зависимости.

## Трек B — Autonomous parity uplift (постепенно)

Цель: выйти к контролируемому качеству автономного режима.

- Системно закрывать источники дрейфа по ключам,
- измерять прогресс не общим процентом, а по бизнес-критичным полям,
- переводить клиентов на автономный режим только после прохождения quality gates.

---

## 4) Целевая архитектура сервиса “канал + бот + подписка”

## 4.1 Минимально-инвазивный вариант

Новый сервис: `tg-subscriptions-service` (отдельный процесс и БД), который интегрируется с текущим `backend_compat`.

Компоненты:

1. `bot-api` (aiogram webhook)
   - команды, меню тарифов, покупка, продление, поддержка.

2. `billing-core`
   - создание invoice,
   - обработка pre-checkout/successful payment,
   - продление/истечение подписки,
   - refund flow.

3. `access-manager`
   - выдача инвайта в приватный канал,
   - валидация membership,
   - автоматическое удаление/ограничение доступа при просрочке.

4. `onboarding-bridge`
   - после оплаты запускает продуктовый onboarding:
     - регистрация spreadsheet,
     - добавление WB токена,
     - smoke-проверка.

## 4.2 Хранилище (MVP)

Таблицы:

- `customers` (telegram_user_id, username, status)
- `plans` (plan_code, price, period_days, is_active)
- `subscriptions` (customer_id, plan_id, status, starts_at, ends_at, auto_renew)
- `payments` (provider, payload, amount, currency, status, telegram_payment_charge_id)
- `access_grants` (customer_id, channel_id, invite_link, granted_at, revoked_at)
- `billing_events` (event_type, raw_json, created_at)
- `support_tickets` (customer_id, topic, status)

Критично:
- UNIQUE на `telegram_payment_charge_id`,
- idempotency_key для операций покупки/активации,
- аудит всех переходов статуса подписки.

---

## 5) Детальный план реализации

## Этап 1 (дни 1-3): Stabilize данные для продаж

1. Зафиксировать production-политику качества:
   - для платящих пользователей: proxy-first для критичных датасетов,
   - автономный режим только при достижении quality gate.
2. Включить обязательный ежедневный сбор снапшотов (`collector/run`) минимум 2-4 раза в сутки.
3. Ввести daily parity dashboard по ключам:
   - `adv_sum`, `avg_price_with_spp`, `stocks_total`, `profit_with_adv`.

Результат:
- перестаем продавать "рандомное качество"; качество становится управляемым.

## Этап 2 (дни 3-6): Telegram foundation

1. Создать бота в BotFather, настроить webhook URL.
2. Развернуть `tg-subscriptions-service` (FastAPI + aiogram webhook mode).
3. Настроить secret token webhook и проверку входящих update.
4. Базовые команды:
   - `/start`, `/plans`, `/buy`, `/status`, `/support`.

Результат:
- бот стабильно принимает события и умеет вести пользователя по воронке.

## Этап 3 (дни 6-10): Платежный контур

1. Реализовать invoice flow:
   - вариант A: Telegram Stars (`XTR`) и подписка 30 дней (`2592000`),
   - вариант B: внешний провайдер через `provider_token` (если нужен фиат).
2. Реализовать обработку:
   - `pre_checkout_query` (ответ <= 10 сек),
   - `successful_payment` (идемпотентная активация подписки).
3. Реализовать возвраты:
   - для Stars — `refundStarPayment` сценарий.

Результат:
- пользователь может купить подписку из Telegram и получить подтверждение.

## Этап 4 (дни 10-14): Доступ в канал + anti-leak

1. Приватный Telegram-канал как основной delivery-контур.
2. После успешной оплаты выдавать одноразовую/короткоживущую invite-ссылку.
3. Периодический job-проверяльщик:
   - активна подписка -> доступ есть,
   - подписка истекла -> доступ отзывается.
4. Анти-шеринг:
   - лимиты выдачи инвайтов,
   - блок повторного использования,
   - ручной флаг fraud.

Результат:
- доступ в платный канал автоматически синхронизирован с оплатой.

## Этап 5 (дни 14-20): Product onboarding после оплаты

1. В боте собрать данные клиента (пошагово):
   - email,
   - spreadsheet_id,
   - WB token.
2. Оркестровать подключение через текущие endpoint'ы backend:
   - `POST /api/admin/spreadsheets/register`
   - `POST /api/admin/wb/tokens/add`
   - `POST /api/ss/wb/token/get`
   - `POST /api/ss/datasets/update` (smoke).
3. Статусы в боте:
   - `Оплата получена` -> `Подключение продукта` -> `Готово`.

Результат:
- покупка и запуск продукта связаны в единый пользовательский путь.

## Этап 6 (дни 20-30): Дожим parity для бизнес-критичных полей

Приоритетный бэклог по drift:

1. `adv_sum`
   - более точная дневная атрибуция расходов по SKU/campaign type,
   - уменьшение эвристик в распределении.
2. `stocks_total` / `stocks_enough_for*`
   - выравнивание дневной семантики остатков и лагов.
3. `avg_price_with_spp`
   - явный режим источника цены и переносов по дням.
4. `profit_with_adv` / `profit_without_adv`
   - калибровки по unit settings и формуле конкурента (в пределах наблюдаемых данных).

Каждый пункт закрывать через:
- фиксированный тестовый диапазон,
- сравнение до/после,
- коммит только при улучшении целевых ключей.

Результат:
- постепенный рост автономного качества без слома монетизации.

---

## 6) Quality gates (чтобы не было хуже конкурентов по UX)

## 6.1 Для Telegram продукта

- Успешная оплата -> доступ в канал <= 60 секунд (P95).
- Доля успешных оплат >= 97%.
- Ошибка pre-checkout timeout = 0.
- Повторное списание/двойная активация = 0.

## 6.2 Для данных продукта

- Для платящих пользователей:
  - критичные отчеты не ниже текущего production baseline.
- Для автономного режима:
  - `numeric_exact_ratio` по целевому набору >= 0.90,
  - по ключам `adv_sum`, `stocks_total`, `profit_with_adv` — отдельные пороги (не только общий ratio).

---

## 7) Наблюдаемость и эксплуатация

Метрики:

- `tg_payments_created_total`, `tg_payments_success_total`, `tg_payments_failed_total`
- `tg_subscription_active_total`, `tg_subscription_expired_total`
- `tg_channel_access_granted_total`, `tg_channel_access_revoked_total`
- `onboarding_success_total`, `onboarding_failed_total`
- `parity_exact_ratio_daily` (общий и по ключам)

Алерты:

- падение конверсии оплаты > X% за 1 час,
- рост ошибок webhook/pre-checkout,
- отставание выдачи доступа в канал,
- падение parity по критичным ключам.

Runbook (обязательно):

- "Оплата прошла, доступ не выдан",
- "Webhook недоступен",
- "Резкий рост parity drift",
- "Массовое истечение подписок/ошибка продления".

---

## 8) Риски и как страхуемся

1. Риск: 1:1 с конкурентом математически недостижим полностью.
   - Мера: dual-track стратегия (продажи на стабильном контуре + controlled parity uplift).

2. Риск: зависимость от внешнего апстрима в proxy-first.
   - Мера: fallback + накопление собственных снапшотов + план постепенного отключения.

3. Риск: злоупотребления в Telegram (sharing, replay, фрод).
   - Мера: короткоживущие invite links, idempotency, rate limit, event audit.

4. Риск: платежные инциденты и спорные списания.
   - Мера: прозрачный ledger платежей, refund policy, ручной override для поддержки.

5. Риск: нестабильность WB источников данных.
   - Мера: snapshot-first, ретраи, диагностические отчеты качества.

---

## 9) Проверки перед запуском

## 9.1 Тесты

- Unit: подписка/продление/истечение/идемпотентность.
- Integration: Telegram webhook + invoice + pre-checkout + payment success.
- E2E: оплата -> доступ в канал -> onboarding -> first successful update.
- Failure drills: webhook down, provider timeout, duplicate update.

## 9.2 Staging прогон

- Тестовый канал и тестовый бот.
- 20-30 тестовых платежей.
- 5-10 циклов revoke/grant доступа.
- Контроль времени до активации и ошибок.

## 9.3 Production rollout

1. Внутренний запуск (команда).
2. Pilot 20-50 пользователей.
3. По KPI — масштабирование на весь поток.

---

## 10) Definition of Done

- Пользователь может купить подписку в Telegram и автоматически получить доступ в канал.
- После оплаты запускается подключение продукта; бот показывает статус до `готово`.
- Контур оплаты и доступа идемпотентен, наблюдаем и управляем.
- Для платящих пользователей обеспечен стабильный контур данных.
- Есть явный roadmap повышения автономного parity с измеримыми quality gates.

---

## 11) Открытые вопросы (не блокируют старт MVP)

- Основная платежная модель на старте: только Telegram Stars или Stars + фиатный провайдер.
- Политика возвратов: автоматическая/ручная/гибрид.
- Тарифная сетка: 1 план или 2-3 уровня (Lite/Pro/Agency).
- Нужна ли партнерская/referral механика в первой версии.

---

## 12) Что делать, если исторических данных конкурента нет (практический анти-кризисный план)

Ключевой факт: без их исторического слоя строгий `1:1` математически недостижим. Это нормально.
Задача — не «угадывать конкурента», а быстро построить управляемое качество на своей истории.

### 12.1 Смена целевого критерия

- Вместо одной метрики «общий % похожести» ввести `quality tiers` по критичным ключам (`adv_sum`, `stocks_total`, `avg_price_with_spp`, `profit_with_adv`).
- Для каждого ключа задать отдельные пороги приемки (MAE/MAPE/exact ratio), потому что общий процент маскирует провалы в деньгах.
- Решение о выдаче данных в прод принимать только по ключевым метрикам, а не по среднему числу.

### 12.2 Построить собственный «исторический слой» за 2-4 недели

1. Включить snapshot-first сбор как обязательный контур:
   - `collector/run` не реже 4 раз в сутки,
   - фиксировать raw + normalized дневные срезы,
   - хранить неизменяемые дневные версии (T+1 freeze).
2. Сделать backfill максимально доступного окна из WB API.
3. Ввести контроль полноты истории: `% nm_id с непрерывным рядом` и `% дней без дыр`.

### 12.3 Холодный старт: гибридный режим для прода

- Для платящих клиентов использовать `proxy-first` на ключевых датасетах, где автономный контур ниже порога.
- Автономный контур использовать там, где он уже в зеленой зоне.
- На уровне ответа хранить `source_tag` (`upstream|local`) для прозрачной диагностики.

### 12.4 Калибровка без доступа к приватной формуле конкурента

- На пересекающемся периоде строить калибровочные коэффициенты по группам (nm_id/category/brand), а не один глобальный множитель.
- Обновлять коэффициенты по расписанию (например, раз в неделю) и включать только при доказанном улучшении на holdout-периоде.
- Не принимать «улучшение» если оно повышает общий % но ухудшает `profit_*` и `adv_sum`.

### 12.5 Правила релиза, чтобы сервис не «сыпался»

- В прод проходят только изменения, которые улучшили минимум 3 из 4 ключевых метрик и не ухудшили остальные сверх лимита.
- Если метрика падает ниже порога, автоматически переключать соответствующий датасет в proxy-first.
- Для Telegram-бота это должно быть прозрачно для пользователя: подписка/доступ работают всегда, источник данных переключается автоматически.

### 12.6 Коммуникация и упаковка продукта

- Продавать не «копию конкурента», а `SLA точности` по ключевым отчетам + стабильность обновления.
- В тарифе фиксировать целевые SLA (например, обновление данных, время до готовности, доступность сервиса).
- Это снижает юридический и репутационный риск обещаний «1:1 при любых условиях».

### 12.7 Быстрый 14-дневный execution plan

- Дни 1-2: включить обязательный snapshot-first + контроль полноты истории.
- Дни 3-4: дашборд качества по ключам + auto-fallback правила.
- Дни 5-7: Telegram оплата + доступ в канал + идемпотентный billing.
- Дни 8-10: автоподключение клиента после оплаты (spreadsheet/token/smoke).
- Дни 11-14: калибровка ключей `adv_sum/stocks/profit` на holdout и выпуск в прод по quality gates.

Итог: даже без исторических данных конкурента сервис можно сделать коммерчески надежным уже сейчас, а точность дожимать управляемо и без остановки продаж.